# Incremental Database Extraction Example
# Extracts new/updated records from a PostgreSQL database using timestamp watermark
#
# Run with:
#   python bronze_extract.py --config docs/examples/configs/incremental/incremental_db_example.yaml --date 2025-01-15

config_version: 1
environment: dev
domain: ecommerce

platform:
  bronze:
    storage_backend: local
    local_path: ./output/bronze

source:
  system: postgres_prod
  table: orders
  type: db
  db:
    # Connection string from environment variable
    connection_string: ${POSTGRES_CONNECTION_STRING}
    # Query with watermark filter using :watermark placeholder
    query: |
      SELECT
        order_id,
        customer_id,
        product_id,
        quantity,
        unit_price,
        order_total,
        discount_amount,
        status,
        shipping_address,
        created_at,
        updated_at
      FROM orders
      WHERE updated_at > :watermark
      ORDER BY updated_at ASC
      LIMIT 100000
    # Connection pool settings for performance
    pool_size: 5
    pool_timeout: 30
  run:
    load_pattern: incremental_merge
    # Watermark configuration
    watermark_column: updated_at
    watermark_type: timestamp
    # Look back 5 minutes to catch concurrent updates
    watermark_lookback: 5m
    # Primary key for merge operations
    primary_keys:
      - order_id
    # Reference mode for weekly full refresh
    reference_mode:
      enabled: true
      role: auto
      cadence_days: 7
    # Output settings
    max_rows_per_file: 100000
    parallel_workers: 4
    cleanup_on_failure: true

# Quality rules
quality_rules:
  - id: order_id_not_null
    expression: "order_id IS NOT NULL"
    level: error
  - id: customer_id_not_null
    expression: "customer_id IS NOT NULL"
    level: error
  - id: valid_order_total
    expression: "order_total >= 0"
    level: warn
  - id: valid_quantity
    expression: "quantity > 0"
    level: warn

# Schema definition
schema:
  expected_columns:
    - name: order_id
      dtype: string
      nullable: false
    - name: customer_id
      dtype: string
      nullable: false
    - name: order_total
      dtype: float64
      nullable: false
    - name: status
      dtype: string
      nullable: false
    - name: updated_at
      dtype: datetime64
      nullable: false
  primary_key: order_id
