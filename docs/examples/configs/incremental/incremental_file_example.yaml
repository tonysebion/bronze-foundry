# Incremental File Extraction Example
# Extracts new files from S3 based on modification time or partition date
#
# Run with:
#   python bronze_extract.py --config docs/examples/configs/incremental/incremental_file_example.yaml --date 2025-01-15

config_version: 1
environment: dev
domain: analytics

platform:
  bronze:
    storage_backend: s3
    s3_bucket: my-data-lake
    s3_prefix: bronze

source:
  system: event_stream
  table: clickstream
  type: file
  file:
    # S3 path pattern with date partitions
    path: s3://source-bucket/events/year={year}/month={month}/day={day}/
    format: parquet
    # Partition columns for date-based filtering
    partition_columns:
      - year
      - month
      - day
    # File pattern within partitions
    file_pattern: "*.parquet"
    # Use partition date as watermark
    partition_watermark: true
    # Or use file modification time
    # watermark_source: file_mtime
  run:
    load_pattern: incremental_append
    # Watermark based on event timestamp in the data
    watermark_column: event_timestamp
    watermark_type: timestamp
    # Look back 1 day to catch late-arriving files
    watermark_lookback: 1d
    # Handle late-arriving data
    late_data:
      mode: allow
      threshold_hours: 48
    # Output settings
    max_rows_per_file: 500000
    parallel_workers: 8
    cleanup_on_failure: true

# Quality rules
quality_rules:
  - id: event_id_not_null
    expression: "event_id IS NOT NULL"
    level: error
  - id: event_timestamp_not_null
    expression: "event_timestamp IS NOT NULL"
    level: error
  - id: user_id_present
    expression: "user_id IS NOT NULL"
    level: warn

# Schema definition
schema:
  expected_columns:
    - name: event_id
      dtype: string
      nullable: false
    - name: user_id
      dtype: string
      nullable: true
    - name: event_type
      dtype: string
      nullable: false
    - name: event_timestamp
      dtype: datetime64
      nullable: false
    - name: properties
      dtype: object
      nullable: true
  primary_key: event_id
