# Incremental API Extraction Example
# Extracts new/updated records from a REST API using timestamp watermark
#
# Run with:
#   python bronze_extract.py --config docs/examples/configs/incremental/incremental_api_example.yaml --date 2025-01-15

config_version: 1
environment: dev
domain: crm

platform:
  bronze:
    storage_backend: local
    local_path: ./output/bronze

source:
  system: salesforce
  table: accounts
  type: api
  api:
    # Salesforce REST API endpoint
    endpoint: ${SALESFORCE_INSTANCE_URL}/services/data/v57.0/query
    method: GET
    auth:
      type: oauth2
      token_url: ${SALESFORCE_TOKEN_URL}
      client_id: ${SALESFORCE_CLIENT_ID}
      client_secret: ${SALESFORCE_CLIENT_SECRET}
    # SOQL query with watermark filter
    # The {watermark} placeholder is replaced with the current watermark value
    query_template: |
      SELECT Id, Name, Industry, AnnualRevenue, CreatedDate, SystemModstamp
      FROM Account
      WHERE SystemModstamp > {watermark}
      ORDER BY SystemModstamp ASC
      LIMIT 10000
    # Pagination for large result sets
    pagination:
      type: cursor
      cursor_field: nextRecordsUrl
      records_field: records
  run:
    load_pattern: incremental_append
    # Watermark configuration
    watermark_column: SystemModstamp
    watermark_type: timestamp
    # Initial watermark for first run (optional)
    # watermark_initial: "2024-01-01T00:00:00Z"
    # Look back 1 hour to catch late updates
    watermark_lookback: 1h
    # Reference mode for hybrid full/delta
    reference_mode:
      enabled: true
      role: auto
      cadence_days: 7  # Full refresh every 7 days
    # Output settings
    max_rows_per_file: 50000
    cleanup_on_failure: true

# Quality rules to validate extracted data
quality_rules:
  - id: id_not_null
    expression: "Id IS NOT NULL"
    level: error
  - id: name_not_empty
    expression: "Name IS NOT NULL AND Name != ''"
    level: warn

# Schema expectations
schema:
  expected_columns:
    - name: Id
      dtype: string
      nullable: false
    - name: Name
      dtype: string
      nullable: false
    - name: Industry
      dtype: string
      nullable: true
    - name: AnnualRevenue
      dtype: float64
      nullable: true
    - name: SystemModstamp
      dtype: datetime64
      nullable: false
  primary_key: Id
