# Resilient API Extraction Example
#
# This example shows how to configure Bronze extraction from a REST API
# with rate limiting and resilience patterns for unreliable sources.
#
# Use this as a starting point for APIs that:
# - Have rate limits (requests per second/minute)
# - Experience intermittent failures
# - Return 429 (Too Many Requests) responses
#
# See: docs/guides/error_handling.md for full documentation

# ============================================================================
# Bronze Configuration
# ============================================================================
bronze:
  source_type: api
  system: external_api
  table: orders

  # Output configuration
  options:
    local_output_dir: ./output
    format: parquet

# ============================================================================
# Source Configuration with Resilience
# ============================================================================
source:
  type: api

  # API endpoint configuration
  url: https://api.example.com/v1/orders
  method: GET

  # Authentication (use environment variables for secrets)
  headers:
    Authorization: "Bearer ${API_TOKEN}"
    Content-Type: application/json

  # Rate limiting - prevents hitting API rate limits
  # The token bucket algorithm allows short bursts while maintaining average rate
  rate_limit:
    rps: 10      # 10 requests per second average
    burst: 20    # Allow bursts up to 20 requests

  # Enable async HTTP for better throughput with rate-limited APIs
  # Async mode allows multiple concurrent requests while respecting rate limits
  async: true

  # Pagination for large datasets
  pagination:
    type: offset
    page_size: 100
    max_pages: 1000

# ============================================================================
# Run Configuration
# ============================================================================
run:
  # Load pattern for this extraction
  load_pattern: incremental_append

  # Watermark for incremental loads
  watermark_column: updated_at

  # Continue extracting even if some requests fail
  # Useful for large extractions where partial data is acceptable
  continue_on_error: true
  max_error_rate: 0.05  # Fail if more than 5% of requests error

# ============================================================================
# Silver Configuration (optional)
# ============================================================================
silver:
  entity_kind: event
  domain: sales
  entity: orders
  version: 1

  natural_keys:
    - order_id

  timestamp_column: updated_at

# ============================================================================
# Resilience Notes
# ============================================================================
#
# Built-in retry behavior (cannot be overridden in config yet):
# - Max attempts: 5
# - Base delay: 0.5s
# - Max delay: 8.0s
# - Backoff: 2x exponential
# - Jitter: 20%
#
# Retryable errors:
# - HTTP 429 (Too Many Requests)
# - HTTP 5xx (Server errors)
# - Connection timeouts
# - Network errors
#
# Non-retryable errors:
# - HTTP 400 (Bad Request)
# - HTTP 401/403 (Auth errors)
# - HTTP 404 (Not Found)
#
# Circuit breaker:
# - Opens after 5 consecutive failures
# - Cooldown: 30 seconds
# - Allows 1 test request during recovery
