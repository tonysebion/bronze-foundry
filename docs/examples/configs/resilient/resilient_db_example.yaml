# Resilient Database Extraction Example
#
# This example shows how to configure Bronze extraction from a database
# with connection resilience for unreliable network connections.
#
# Use this as a starting point for databases that:
# - Have intermittent connectivity issues
# - Experience connection pool exhaustion
# - Have network latency or timeout issues
#
# See: docs/guides/error_handling.md for full documentation

# ============================================================================
# Bronze Configuration
# ============================================================================
bronze:
  source_type: database
  system: enterprise_db
  table: customers

  # Output configuration
  options:
    local_output_dir: ./output
    format: parquet

# ============================================================================
# Source Configuration with Resilience
# ============================================================================
source:
  type: database

  # Database connection (use environment variables for secrets)
  # Connection strings should be stored securely
  connection_string: "${DB_CONNECTION_STRING}"

  # Alternatively, specify components separately:
  # driver: ODBC Driver 17 for SQL Server
  # server: db.example.com
  # database: production
  # username: "${DB_USER}"
  # password: "${DB_PASSWORD}"

  # Query to extract data
  query: |
    SELECT
      customer_id,
      name,
      email,
      created_at,
      updated_at
    FROM customers
    WHERE updated_at >= :start_date
      AND updated_at < :end_date

  # Query parameters (injected at runtime)
  params:
    start_date: "${RUN_START_DATE}"
    end_date: "${RUN_END_DATE}"

# ============================================================================
# Run Configuration
# ============================================================================
run:
  # Load pattern for this extraction
  load_pattern: incremental_append

  # Watermark for incremental loads
  watermark_column: updated_at

  # Chunk large result sets to manage memory
  chunk_size: 10000

# ============================================================================
# Silver Configuration (optional)
# ============================================================================
silver:
  entity_kind: state
  domain: crm
  entity: customers
  version: 1

  natural_keys:
    - customer_id

  timestamp_column: updated_at

# ============================================================================
# Resilience Notes
# ============================================================================
#
# Database-specific retry behavior:
# - Connection errors are retryable
# - Query timeouts are retryable
# - Authentication failures are NOT retryable
# - Syntax errors are NOT retryable
#
# Built-in defaults:
# - Max attempts: 5
# - Base delay: 0.5s (consider increasing for DB connections)
# - Max delay: 8.0s
# - Backoff: 2x exponential
#
# Circuit breaker:
# - Opens after 5 consecutive connection failures
# - Prevents overwhelming a struggling database
# - Cooldown: 30 seconds before retry
#
# Best practices for databases:
# 1. Use connection pooling at the infrastructure level
# 2. Set appropriate query timeouts
# 3. Chunk large queries to avoid timeouts
# 4. Use read replicas for extraction workloads
