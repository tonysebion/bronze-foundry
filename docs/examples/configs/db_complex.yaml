platform:
  bronze:
    s3_bucket: "enterprise-bronze"
    s3_prefix: "bronze/customers"
    partitioning:
      use_dt_partition: true
      partition_strategy: "hourly"
    output_defaults:
      allow_csv: false
      allow_parquet: true
      parquet_compression: "zstd"

sources:
  - name: customer_snapshot
    source:
      type: "db"
      system: "customers_dw"
      table: "customer_snapshot"
      db:
        conn_str_env: "CUSTOMER_DB_CONN"
        base_query: |
          SELECT ClaimID, MemberID, ServiceDate, Amount, UpdatedAt
          FROM dbo.ClaimsHeader
          WHERE UpdatedAt >= ? AND UpdatedAt < ?
        incremental:
          enabled: true
          cursor_column: "UpdatedAt"
          state_file: "./state/customers.cursor"
          cursor_type: "datetime"
      run:
        load_pattern: "current_history"
        write_parquet: true
        write_csv: false
        parallel_workers: 8
        max_file_size_mb: 512
        require_checksum: true
        cleanup_on_failure: true
  - name: claim_cdc
    source:
      type: "db"
      system: "claims_dw"
      table: "claims_cdc"
      db:
        conn_str_env: "CLAIMS_DB_CONN_STR"
        base_query: |
          SELECT ClaimID, Status, UpdatedAt
          FROM dbo.ClaimsDelta
      run:
        load_pattern: "cdc"
        write_parquet: true
        write_csv: false
        max_rows_per_file: 400000
        require_checksum: true

silver:
  write_parquet: true
  write_csv: false
  partitioning:
    columns: ["region"]
  normalization:
    trim_strings: true
    empty_strings_as_null: true
  schema:
    rename_map:
      ClaimID: claim_id
      UpdatedAt: updated_at
    column_order:
      - claim_id
      - member_id
      - service_date
      - amount
      - updated_at
  error_handling:
    enabled: true
    max_bad_records: 50
    max_bad_percent: 1.0
  require_checksum: true
